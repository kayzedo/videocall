function VideoCall(e){"use strict";function m(e){var n={};u=new RTCPeerConnection(n),u.onaddstream=function(e){a=e.stream,c.srcObject=e.stream,p=!0},u.onicecandidate=function(e){var n;e.candidate&&(n={type:"candidate",data:e.candidate},t.server.sendMessage(f,n).fail(function(e){console.log("IceCandidate could not be sent.",e)}))},u.addStream(e)}function C(){o.getTracks().forEach(function(e){e.stop()}),o=null,a=null,u&&u.close(),f=null,s.srcObject=null,c.srcObject=null}function h(){g&&v.hangup()}function b(){$(l).hasClass("disabled")?o&&o.getAudioTracks().length>0&&(o.getAudioTracks()[0].enabled=!0):o&&o.getAudioTracks().length>0&&(o.getAudioTracks()[0].enabled=!1),$(l).toggleClass("disabled")}function E(){c.muted=$(d).hasClass("disabled")?!1:!0,$(d).toggleClass("disabled")}var n,t,o,a,s,c,i,r,l,d,u,f,g=!1,p=!1,v=this;t=$.connection.videoCallHub,t.client.onMessage=function(e,n){switch(e.type){case"text":v.onMessage(e.data,n);break;case"call":f=n,v.onCall(n);break;case"hangup":C(),v.onHangup();break;case"response":if(e.data)u.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0}).then(function(e){u.setLocalDescription(e);var o={type:"offer",data:e};t.server.sendMessage(n,o).fail(function(e){console.log("Offer could not be sent.",e)})}).catch(function(e){console.log("Error creating offer.",e)});else{var o={message:"IceCandidate could not be sent.",src:"VideoCall::peerConn.onicecandidate(evt)",stack:err};v.onError(o)}break;case"answer":u.setRemoteDescription(new RTCSessionDescription(e.data));break;case"candidate":u.addIceCandidate(new RTCIceCandidate(e.data));break;case"offer":u.setRemoteDescription(new RTCSessionDescription(e.data)),u.createAnswer().then(function(e){u.setLocalDescription(e);var o={type:"answer",data:e};t.server.sendMessage(n,o).fail(function(e){console.log("Answer could not be sent.",e)})}).catch(function(e){console.log("Error creating answer.",e)})}},t.client.disconnect=function(){$.connection.hub.stop()},$.connection.hub.disconnected(function(){$.connection.hub.lastError?(console.log("Disconnected:",$.connection.hub.lastError),v.onDisconnected(!1)):(console.log("Client explicitly close connection."),v.onDisconnected(!0))}),this.onConnected=$.noop,this.onDisconnected=$.noop,this.onCall=$.noop,this.onError=$.noop,this.onHangup=$.noop,this.onMessage=$.noop,this.connect=function(e){var t;e?(n=e,$.connection.hub.qs={user:n},$.connection.hub.start().done(function(){console.log("Connected. ["+$.connection.hub.transport.name+"]"),g=!0,v.onConnected()}).fail(function(e){var n={message:"Communication with signaling service could not be established.",src:"VideoCall::connect(iduser)",type:"ERR_CONNECTION",stack:e};v.onError(n)})):(t={message:"The 'iduser' argument is null.",src:"VideoCall::connect(iduser)",type:"ERR_ARGUMENT",stack:null},v.onError(t))},this.disconnect=function(){$.connection.hub.stop(),v.hangup()},this.callTo=function(e){f=e,f?t.server.isOnline(f).done(function(e){var n={audio:!0,video:!0};if(e)if(navigator.mediaDevices)navigator.mediaDevices.getUserMedia(n).then(function(e){var n={type:"call",data:null};o=e,s.srcObject=e,m(e),t.server.sendMessage(f,n).fail(function(e){console.log("Hangup could not be sent.",e)})}).catch(function(e){var n={message:"Could not access camera and microphone.",src:"VideoCall::navigator.mediaDevices.getUserMedia(constraints)",type:"ERR_MEDIA_DEVICES",stack:e};v.onError(n)});else{var a={message:"Browser not support MediaDevices.",src:"VideoCall::navigator.mediaDevices.getUserMedia(constraints)",type:"ERR_BROWSER_SUPPORT",stack:err};v.onError(a)}else{var a={message:f+" is offline.",src:"VideoCall::callTo(idcallee)",type:"ERR_CONNECTION",stack:null};v.onError(a)}}).fail(function(e){var n={message:"Communication with signaling service could not be established.",src:"VideoCall::signaling.server.isOnline(callee)",type:"ERR_CONNECTION",stack:e};v.onError(n)}):(error={message:"The 'callee' argument is null.",src:"VideoCall::connect(iduser)",type:"ERR_ARGUMENT",stack:null},v.onError(error))},this.hangup=function(){if(p){var e={type:"hangup",data:null};t.server.sendMessage(f,e).fail(function(e){console.log("Hangup could not be sent.",e)}),C()}},this.acceptCall=function(){var e={audio:!0,video:!0};if(navigator.mediaDevices)navigator.mediaDevices.getUserMedia(e).then(function(e){var n={type:"response",data:!0};o=e,s.srcObject=e,m(e),t.server.sendMessage(f,n).fail(function(e){console.log("Accept call could not be sent.",e)})}).catch(function(e){var n={message:"Could not access camera and microphone.",src:"VideoCall::navigator.mediaDevices.getUserMedia(constraints)",type:"ERR_MEDIA_DEVICES",stack:e};v.onError(n)});else{var n={message:"Browser not support MediaDevices.",src:"VideoCall::navigator.mediaDevices.getUserMedia(constraints)",type:"ERR_BROWSER_SUPPORT",stack:err};v.onError(n)}},this.rejectCall=function(){var e={type:"response",data:!1};t.server.sendMessage(f,e).fail(function(e){console.log("Reject call could not be sent.",e)}),f=null},this.sendMessage=function(e,n){g&&t.server.sendMessage(e,n)},s=document.createElement("video"),s.className="localVideo",s.setAttribute("muted",!0),s.setAttribute("autoplay",!0),s.setAttribute("poster","/img/operator.png"),s.removeAttribute("controls"),c=document.createElement("video"),c.className="remoteVideo",c.setAttribute("autoplay",!0),c.setAttribute("poster","/img/client.png"),c.removeAttribute("controls"),i=document.createElement("div"),i.className="panelControls",r=document.createElement("div"),r.id="callCtrl",r.onclick=h,l=document.createElement("div"),l.id="micCtrl",l.onclick=b,d=document.createElement("div"),d.id="volumeCtrl",d.onclick=E,i.appendChild(l),i.appendChild(d),i.appendChild(r),e.target?($(e.target).append(c),$(e.target).append(s),$(e.target).append(i)):(document.appendChild(c),document.appendChild(s),document.appendChild(i))}