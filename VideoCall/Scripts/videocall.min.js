function VideoCall(e){"use strict";function v(e){var t={iceServers:[{urls:["stun:w2.xirsys.com"]},{urls:["turn:w2.xirsys.com:80?transport=udp","turn:w2.xirsys.com:3478?transport=udp","turn:w2.xirsys.com:80?transport=tcp","turn:w2.xirsys.com:3478?transport=tcp"],username:"9fef6730-6805-11e7-8ccf-12cec95ee707",credential:"9fef67b2-6805-11e7-bb24-c7e23692bf1d"}]};u=new RTCPeerConnection(t),u.onaddstream=function(e){s=e.stream,c.srcObject=e.stream,m=!0},u.onicecandidate=function(e){var t;e.candidate&&(t={type:"candidate",data:e.candidate},o.invoke("sendMessage",f,t).fail(function(e){console.log("IceCandidate could not be sent.",e)}))},u.addStream(e)}function h(){a.getTracks().forEach(function(e){e.stop()}),a=null,s=null,u&&u.close(),m=!1,f=null,i.srcObject=null,c.srcObject=null}function C(){g&&p.hangup()}function b(){$(l).hasClass("disabled")?a&&a.getAudioTracks().length>0&&(a.getAudioTracks()[0].enabled=!0):a&&a.getAudioTracks().length>0&&(a.getAudioTracks()[0].enabled=!1),$(l).toggleClass("disabled")}function E(){c.muted=$(d).hasClass("disabled")?!1:!0,$(d).toggleClass("disabled")}var t,n,o,a,s,i,c,r,l,d,u,f,g=!1,m=!1,p=this;n=$.hubConnection("https://webrtc.myteledocx.com/signalr",{useDefaultPath:!1}),o=n.createHubProxy("videoCallHub"),o.on("onMessage",function(e,t){switch(e.type){case"text":p.onMessage(e.data,t);break;case"call":f=t,p.onCall(t);break;case"hangup":h(),p.onHangup();break;case"response":if(e.data)u.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0}).then(function(e){u.setLocalDescription(e);var n={type:"offer",data:e};o.invoke("sendMessage",t,n).fail(function(e){console.log("Offer could not be sent.",e)})}).catch(function(e){console.log("Error creating offer.",e)});else{var n={message:"IceCandidate could not be sent.",src:"VideoCall::peerConn.onicecandidate(evt)",stack:err};p.onError(n)}break;case"answer":u.setRemoteDescription(new RTCSessionDescription(e.data));break;case"candidate":u.addIceCandidate(new RTCIceCandidate(e.data));break;case"offer":u.setRemoteDescription(new RTCSessionDescription(e.data)),u.createAnswer().then(function(e){u.setLocalDescription(e);var n={type:"answer",data:e};o.invoke("sendMessage",t,n).fail(function(e){console.log("Answer could not be sent.",e)})}).catch(function(e){console.log("Error creating answer.",e)})}}),o.on("disconnect",function(){n.stop()}),n.disconnected(function(){n.lastError?(console.log("Disconnected:",n.lastError),p.onDisconnected(!1)):(console.log("Client explicitly close connection."),p.onDisconnected(!0))}),this.onConnected=$.noop,this.onDisconnected=$.noop,this.onCall=$.noop,this.onError=$.noop,this.onHangup=$.noop,this.onMessage=$.noop,this.isTalking=function(){return m},this.connect=function(e){var o;e?(t=e,n.qs={user:t},n.start().done(function(){console.log("Connected. ["+n.transport.name+"]"),g=!0,p.onConnected()}).fail(function(e){var t={message:"Communication with signaling service could not be established.",src:"VideoCall::connect(iduser)",type:"ERR_CONNECTION",stack:e};p.onError(t)})):(o={message:"The 'iduser' argument is null.",src:"VideoCall::connect(iduser)",type:"ERR_ARGUMENT",stack:null},p.onError(o))},this.disconnect=function(){n.stop(),p.hangup()},this.callTo=function(e,t){f=e,f?o.invoke("isOnline",f).done(function(e){var n=$.extend({audio:!0,video:!0},t);if(console.log(n),e)if(navigator.mediaDevices)navigator.mediaDevices.getUserMedia(n).then(function(e){var t={type:"call",data:null};a=e,i.srcObject=e,v(e),o.invoke("sendMessage",f,t).fail(function(e){console.log("Hangup could not be sent.",e)})}).catch(function(e){var t={message:"Could not access camera and microphone.",src:"VideoCall::navigator.mediaDevices.getUserMedia(constraints)",type:"ERR_MEDIA_DEVICES",stack:e};p.onError(t)});else{var s={message:"Browser not support MediaDevices.",src:"VideoCall::navigator.mediaDevices.getUserMedia(constraints)",type:"ERR_BROWSER_SUPPORT",stack:err};p.onError(s)}else{var s={message:f+" is offline.",src:"VideoCall::callTo(idcallee)",type:"ERR_CONNECTION",stack:null};p.onError(s)}}).fail(function(e){var t={message:"Communication with signaling service could not be established.",src:"VideoCall::signaling.server.isOnline(callee)",type:"ERR_CONNECTION",stack:e};p.onError(t)}):(error={message:"The 'callee' argument is null.",src:"VideoCall::connect(iduser)",type:"ERR_ARGUMENT",stack:null},p.onError(error))},this.hangup=function(){if(m){var e={type:"hangup",data:null};o.invoke("sendMessage",f,e).fail(function(e){console.log("Hangup could not be sent.",e)}),h()}},this.acceptCall=function(){var e={audio:!0,video:!0};if(navigator.mediaDevices)navigator.mediaDevices.getUserMedia(e).then(function(e){var t={type:"response",data:!0};a=e,i.srcObject=e,v(e),o.invoke("sendMessage",f,t).fail(function(e){console.log("Accept call could not be sent.",e)})}).catch(function(e){var t={message:"Could not access camera and microphone.",src:"VideoCall::navigator.mediaDevices.getUserMedia(constraints)",type:"ERR_MEDIA_DEVICES",stack:e};p.onError(t)});else{var t={message:"Browser not support MediaDevices.",src:"VideoCall::navigator.mediaDevices.getUserMedia(constraints)",type:"ERR_BROWSER_SUPPORT",stack:err};p.onError(t)}},this.rejectCall=function(){var e={type:"response",data:!1};o.invoke("sendMessage",f,e).fail(function(e){console.log("Reject call could not be sent.",e)}),f=null},this.sendMessage=function(e,t){g&&o.invoke("sendMessage",e,t)},this.muteMic=function(){console.log("muteMic",!a.getAudioTracks()[0].enabled),a&&a.getAudioTracks().length>0&&(a.getAudioTracks()[0].enabled=!a.getAudioTracks()[0].enabled)},this.muteVideo=function(){c.muted=!c.muted},i=document.createElement("video"),i.className="localVideo",i.setAttribute("muted",!0),i.setAttribute("autoplay",!0),i.setAttribute("poster","https://www.myteledocx.com/images/teledocx_logo.png"),i.removeAttribute("controls"),c=document.createElement("video"),c.className="remoteVideo",c.setAttribute("autoplay",!0),c.setAttribute("poster","https://www.myteledocx.com/VirtualOfficeImages/0.png"),c.removeAttribute("controls"),r=document.createElement("div"),r.id="callCtrl",r.className="callCtrl",r.onclick=C,l=document.createElement("div"),l.id="micCtrl",l.className="micCtrl",l.onclick=b,d=document.createElement("div"),d.id="volumeCtrl",d.className="volumeCtrl",d.onclick=E,e.target?($(e.target).append(c),$(e.target).append(i)):(document.appendChild(c),document.appendChild(i)),setInterval(function(){c.setAttribute("poster","https://www.myteledocx.com/VirtualOfficeImages/"+Math.floor(5*Math.random())+".png")},1e4)}